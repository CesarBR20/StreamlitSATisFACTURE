# SATisFacture - Frontend Demo (Streamlit)

## Descripci√≥n del Proyecto

Frontend de demostraci√≥n desarrollado en Streamlit para **SATisFacture**, que permite a usuarios y administradores gestionar certificados FIEL, realizar solicitudes al SAT, y visualizar CFDI y metadata de forma intuitiva.

Este frontend sirve como **interfaz de pruebas interna** para validar el flujo completo de operaciones con el backend de integraci√≥n SAT alojado en AWS ECS.

### Tipo de Proyecto

**Aplicaci√≥n Web Interactiva** - Demo frontend en Streamlit

### Usuarios Objetivo

1. **Administradores:** Gesti√≥n completa de grupos, clientes, usuarios y solicitudes SAT
2. **Clientes:** Subida de certificados FIEL y visualizaci√≥n de sus propios datos fiscales
3. **Equipo de desarrollo:** Pruebas y validaci√≥n del flujo de integraci√≥n SAT

## Caracter√≠sticas Principales

### Para Administradores

- **Gesti√≥n de grupos:** Crear, modificar y eliminar grupos de empresas
- **Gesti√≥n de clientes:** Asignar RFCs a grupos, administrar certificados FIEL
- **Gesti√≥n de usuarios:** Crear usuarios con roles (admin/cliente) y asignarlos a grupos
- **Solicitudes SAT:** Ejecutar solicitudes iniciales autom√°ticas para m√∫ltiples a√±os
- **Verificaci√≥n masiva:** Verificar estado de solicitudes por a√±o
- **Visualizaci√≥n de datos:** Consultar CFDI y metadata por cliente y a√±o

### Para Clientes

- **Consentimiento informado:** Aceptaci√≥n de t√©rminos y condiciones para uso de FIEL
- **Subida de certificados:** Upload de archivos .cer, .key y password.txt
- **Historial de certificados:** Ver certificados subidos por el grupo
- **Validaci√≥n autom√°tica:** Verificaci√≥n de archivos antes de enviar al backend

## Stack Tecnol√≥gico

### Lenguajes y Frameworks

- **Python:** 3.12.9
- **Streamlit:** Framework para aplicaciones web interactivas - [https://streamlit.io/](https://streamlit.io/)

### Bibliotecas Principales

- **streamlit:** Framework principal para la interfaz web
- **bcrypt:** Hashing de contrase√±as para autenticaci√≥n local
- **requests:** Cliente HTTP para comunicaci√≥n con el backend SAT
- **pymongo:** Driver de MongoDB para acceso directo a base de datos

## Dependencias Externas

### Servicios Requeridos

#### 1. Backend SAT API (AWS ECS)

- **URL Base:** `http://sat-api-alb-532045601.us-east-1.elb.amazonaws.com`
- **Endpoints utilizados:**
  - `/convert-and-upload-certificates/` - Subida de certificados FIEL
  - `/auth-sat/` - Autenticaci√≥n con el SAT
  - `/ejecutar-solicitudes-iniciales/` - Solicitudes masivas por a√±o
  - `/verificar-solicitudes/` - Verificaci√≥n de estado de solicitudes

#### 2. Base de Datos MongoDB

- **Tipo:** MongoDB Atlas (cloud)
- **URI:** Configurada en variable de entorno `MONGODB_URI`
- **Base de datos:** Configurada en variable de entorno `MONGODB_DB` (default: `sat_cfdi`)
- **Colecciones utilizadas:**
  - `usuarios` - Autenticaci√≥n y roles
  - `grupos` - Grupos de empresas
  - `clientes` - RFCs y certificados
  - `uploads` - Log de certificados subidos
  - `cfdi` - Comprobantes fiscales procesados
  - `metadata` - Metadata de comprobantes

## Iniciar el Proyecto

### Instalar Dependencias

```bash
# Instalar dependencias del proyecto
pip install -r requirements.txt
```

**Contenido de `requirements.txt`:**
```
streamlit
bcrypt
requests
pymongo
```

### Configuraci√≥n de Variables de Entorno

Crear un archivo `.env` en la ra√≠z del proyecto o configurar variables de entorno del sistema:

```bash
# MongoDB
MONGODB_URI=mongodb+srv://usuario:password@cluster.mongodb.net/sat_cfdi?retryWrites=true&w=majority
MONGODB_DB=sat_cfdi
```

**Nota:** Si no se configuran variables de entorno, la aplicaci√≥n usa valores por defecto hardcodeados (solo para desarrollo).

### Iniciar la Aplicaci√≥n

#### Modo Local

```bash
# Iniciar servidor Streamlit
streamlit run app.py
```

La aplicaci√≥n estar√° disponible en:
- **URL local:** http://localhost:8501
- **URL de red:** Se mostrar√° en la terminal al iniciar

#### Configuraci√≥n de Puerto

```bash
# Especificar puerto personalizado
streamlit run app.py --server.port 8080
```

#### Modo Producci√≥n

```bash
# Con configuraci√≥n espec√≠fica
streamlit run app.py \
    --server.port 8501 \
    --server.address 0.0.0.0 \
    --server.headless true
```

## Arquitectura de la Aplicaci√≥n

### Estructura de Sesi√≥n

La aplicaci√≥n utiliza `st.session_state` para mantener el estado durante la sesi√≥n del usuario:

```python
# Estados principales
st.session_state.stage           # "landing" | "app"
st.session_state.auth             # True | False
st.session_state.role             # "admin" | "cliente"
st.session_state.username         # Nombre de usuario autenticado
st.session_state.consent_confirmed # True | False (solo clientes)

# Estados de interfaz
st.session_state.ui_section       # Secci√≥n activa del men√∫
st.session_state.confirmed_client_id   # Cliente seleccionado (admin)
st.session_state.confirmed_client_rfc  # RFC del cliente seleccionado
st.session_state.sat_token_ready       # Estado de autenticaci√≥n SAT
```

### Flujo de Navegaci√≥n

```
Landing (Login)
    ‚Üì
App Principal
    ‚Üì
    ‚îú‚îÄ‚îÄ ADMIN
    ‚îÇ   ‚îú‚îÄ‚îÄ Alta de grupo
    ‚îÇ   ‚îú‚îÄ‚îÄ Alta de cliente
    ‚îÇ   ‚îú‚îÄ‚îÄ Clientes (listado)
    ‚îÇ   ‚îú‚îÄ‚îÄ Usuarios (gesti√≥n)
    ‚îÇ   ‚îî‚îÄ‚îÄ [Cliente seleccionado]
    ‚îÇ       ‚îú‚îÄ‚îÄ Solicitudes iniciales
    ‚îÇ       ‚îî‚îÄ‚îÄ Visualizaci√≥n (CFDI/Metadata)
    ‚îÇ
    ‚îî‚îÄ‚îÄ CLIENTE
        ‚îî‚îÄ‚îÄ Alta de cliente (subir FIEL)
```

## Funcionalidades Detalladas

### Sistema de Autenticaci√≥n

#### Credenciales por Defecto

```
Usuario: admin
Contrase√±a: admin123
Rol: admin
```

**‚ö†Ô∏è IMPORTANTE:** Cambiar credenciales en producci√≥n.

#### Proceso de Login

1. Usuario ingresa credenciales en formulario
2. Sistema verifica contra colecci√≥n `usuarios` en MongoDB
3. Contrase√±a se valida con bcrypt
4. Si es v√°lido, se guarda informaci√≥n en `session_state`
5. Redirecci√≥n a vista correspondiente seg√∫n rol

### Gesti√≥n de Grupos (Admin)

#### Crear Grupo

```
1. Ir a "Alta de grupo"
2. Ingresar nombre del grupo
3. Sistema genera slug autom√°ticamente
4. Click en "Guardar grupo"
```

**Validaciones:**
- Nombre no puede estar vac√≠o
- Slug debe ser √∫nico en la base de datos

#### Gestionar Miembros

```
1. Seleccionar grupo existente
2. Ver lista de miembros actuales
3. Opciones:
   - Agregar clientes sin grupo
   - Quitar clientes del grupo
   - Eliminar grupo completo
```

### Gesti√≥n de Clientes

#### Alta de Cliente (Admin)

```
1. Ir a "Alta de cliente"
2. Ingresar:
   - RFC (obligatorio, se convierte a may√∫sculas)
   - Raz√≥n social (opcional)
   - Archivo .cer
   - Archivo .key
   - Archivo password.txt
3. Click en "Guardar y subir certificados"
```

**Proceso backend:**
1. Archivos se env√≠an a `/convert-and-upload-certificates/`
2. Backend convierte .cer/.key a formato .pem
3. Archivos se almacenan en S3
4. Cliente se registra en MongoDB (si no existe)

#### Alta de Cliente (Cliente)

**Flujo con consentimiento:**

```
1. Usuario cliente inicia sesi√≥n
2. Sistema verifica grupo asignado
3. Mostrar aviso de confidencialidad
4. Usuario acepta dos checkboxes:
   ‚úì He le√≠do y acepto el aviso
   ‚úì Soy consciente del uso de mi e.firma
5. Click en "Aceptar"
6. Formulario de subida:
   - Nombre del usuario
   - RFC de la empresa
   - Raz√≥n social (opcional)
   - Archivos FIEL
7. Sistema valida que password.txt se llame exactamente as√≠
8. Upload y registro en base de datos
```

**Validaciones especiales:**
- No se puede subir el mismo RFC dos veces por un usuario
- Archivo de contrase√±a debe llamarse exactamente `password.txt`
- Si el usuario ya subi√≥ certificados, puede subir otros para RFCs diferentes

### Solicitudes SAT (Admin con Cliente Seleccionado)

#### Ejecutar Solicitudes Iniciales

```
1. Seleccionar cliente desde sidebar
2. Ir a tab "Solicitudes iniciales"
3. Seleccionar a√±o objetivo
4. Click en "Ejecutar solicitudes iniciales"
```

**Proceso:**
- Env√≠a solicitud al backend para generar autom√°ticamente:
  - CFDI Emitidos: 12 solicitudes (1 por mes)
  - CFDI Recibidos: 12 solicitudes (1 por mes)
  - Metadata Emitidos: 2 solicitudes (semestral)
  - Metadata Recibidos: 2 solicitudes (semestral)
- Total: 28 solicitudes por a√±o
- Tambi√©n genera solicitudes para a√±o-1 y primeros 3 meses de a√±o+1

**Tiempo de ejecuci√≥n:** ~10 minutos

La interfaz usa `ThreadPoolExecutor` para no bloquear la UI durante la espera.

#### Verificar Solicitudes

**Prerequisito:** Autenticaci√≥n SAT

```
1. Click en "Autenticar con SAT"
2. Esperar confirmaci√≥n
3. Click en "Verificar solicitudes"
4. Sistema consulta estado de todas las solicitudes del a√±o
```

**Tabla de resultados muestra:**
- ID de solicitud
- Estado (1-6)
- C√≥digo de respuesta SAT
- Mensaje
- N√∫mero de CFDIs
- N√∫mero de paquetes disponibles

### Visualizaci√≥n de Datos

#### Ver CFDI y Metadata

```
1. Con cliente seleccionado
2. Ir a tab "Visualizaci√≥n"
3. Seleccionar a√±o
4. Click en "Actualizar"
```

**Tabla CFDI muestra:**
- Fecha de emisi√≥n
- UUID
- Tipo de comprobante
- Serie y Folio
- Total
- Emisor y Receptor
- Sentido (Emitido/Recibido)

**Tabla Metadata muestra:**
- Fecha de emisi√≥n
- UUID
- Efecto (I/E/P)
- Monto
- RFCs emisor y receptor
- Estatus (1=Vigente, 0=Cancelado)
- Fecha de certificaci√≥n SAT

**Filtrado:**
- Solo muestra documentos del a√±o seleccionado
- Verifica tanto `FechaEmision` como `fechaProcesado`

## Estructura del C√≥digo

### Funciones Principales

#### Base de Datos

```python
get_db()                          # Obtiene conexi√≥n MongoDB
ensure_group_collection(db)       # Crea colecci√≥n grupos si no existe
ensure_group_indexes(db)          # Crea √≠ndices √∫nicos
ensure_user_indexes(db)           # Crea √≠ndices de usuarios
ensure_logs_collection(db)        # Crea colecci√≥n uploads
ensure_default_admin(db)          # Crea usuario admin por defecto
```

#### Gesti√≥n de Grupos

```python
create_group(db, nombre)                      # Crear nuevo grupo
list_groups(db)                                # Listar todos los grupos
group_members(db, group_id)                   # Miembros de un grupo
assign_client_to_group(db, client_id, group_id) # Asignar cliente
remove_client_from_group(db, client_id, group_id) # Quitar cliente
delete_group(db, group_id)                    # Eliminar grupo
```

#### Gesti√≥n de Clientes

```python
list_clients(db)                  # Listar todos los clientes
clients_without_group(db)         # Clientes sin grupo asignado
clients_in_group(db, group_id)   # Clientes de un grupo espec√≠fico
```

#### Gesti√≥n de Usuarios

```python
create_user(db, username, password, role, group_id) # Crear usuario
verify_user(db, username, password)                  # Validar login
```

#### Logging

```python
log_upload(db, rfc, uploader_username, uploader_name, group_id, status_code) 
# Registra subidas de certificados
```

#### Navegaci√≥n

```python
go_to_app()        # Cambiar a vista de aplicaci√≥n
go_to_landing()    # Volver a login (logout)
view_landing()     # Renderizar pantalla de login
view_app()         # Renderizar aplicaci√≥n principal
```

## Seguridad

### Implementado

- **Hashing de contrase√±as:** bcrypt con salt autom√°tico
- **Autenticaci√≥n de sesi√≥n:** Estado guardado en `session_state`
- **Roles y permisos:** Admin vs Cliente con vistas diferenciadas
- **Validaci√≥n de archivos:** Nombres y tipos de archivo
- **Consentimiento informado:** Aceptaci√≥n expl√≠cita para clientes
- **Logging de operaciones:** Registro de uploads en BD

### Limitaciones Conocidas

- No hay JWT - autenticaci√≥n solo vive en sesi√≥n de Streamlit
- Conexi√≥n directa a MongoDB - no hay capa de API para datos
- Credenciales de admin hardcodeadas en c√≥digo
- Sin rate limiting para prevenir abuso
- Sin 2FA para usuarios admin

### Mejoras de Seguridad (Roadmap)

- Implementar JWT para autenticaci√≥n persistente
- Mover acceso a MongoDB detr√°s de API
- Sistema de gesti√≥n de credenciales de admin
- 2FA para usuarios admin
- Logs de auditor√≠a para operaciones sensibles
- Rate limiting por usuario
- Timeout de sesi√≥n autom√°tico

## Integraci√≥n con Backend

### Endpoints Utilizados

#### 1. Convertir y Subir Certificados

```python
POST /convert-and-upload-certificates/

# Payload (multipart/form-data)
{
    "rfc": "RFC123456789",
    "cer_file": <archivo .cer>,
    "key_file": <archivo .key>,
    "password_file": <archivo password.txt>
}

# Response (200 OK)
{
    "status": "success",
    "message": "FIEL almacenada correctamente"
}
```

#### 2. Autenticar con SAT

```python
POST /auth-sat/

# Payload (form-data)
{
    "rfc": "RFC123456789"
}

# Response (200 OK)
{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 3. Ejecutar Solicitudes Iniciales

```python
POST /ejecutar-solicitudes-iniciales/

# Payload (form-data)
{
    "rfc": "RFC123456789",
    "year": 2024
}

# Response (200 OK)
{
    "status": "success",
    "solicitudes_creadas": 28,
    "detalle": [...]
}
```

**Timeout:** Este endpoint puede tardar ~10 minutos. El frontend usa `timeout=None`.

#### 4. Verificar Solicitudes

```python
POST /verificar-solicitudes/

# Payload (form-data)
{
    "rfc": "RFC123456789",
    "year": 2024
}

# Response (200 OK)
{
    "message": "Verificacion completada",
    "resultados": [
        {
            "id_solicitud": "uuid",
            "estado": "3",
            "codigo_estados": "5000",
            "numero_cfdis": "150",
            "paquetes": ["paquete_01", "paquete_02"]
        }
    ]
}
```

### Manejo de Errores

```python
# Timeout personalizado
requests.post(url, data=payload, timeout=(10, 120))
# (10 segundos para conectar, 120 segundos para respuesta)

# Sin timeout (operaciones largas)
requests.post(url, data=payload, timeout=None)

# Manejo de errores
try:
    response = requests.post(url, data=payload)
    if response.status_code >= 400:
        st.error("Error en la operaci√≥n")
        st.json(response.json(), expanded=False)
    else:
        st.success("Operaci√≥n exitosa")
except requests.exceptions.RequestException as e:
    st.error(f"Fallo al conectar: {e}")
```

## Troubleshooting

### Problemas Comunes

#### 1. Error: "No module named 'streamlit'"

**Causa:** Dependencias no instaladas

**Soluci√≥n:**
```bash
pip install -r requirements.txt
```

#### 2. Error: "ServerSelectionTimeoutError"

**Causa:** No se puede conectar a MongoDB

**Soluci√≥n:**
```bash
# Verificar URI de MongoDB
echo $MONGODB_URI

# Probar conectividad
mongosh "mongodb+srv://..."

# Verificar whitelist de IP en MongoDB Atlas
```

#### 3. Error: "Connection refused" al llamar backend

**Causa:** Backend no est√° disponible o URL incorrecta

**Soluci√≥n:**
```bash
# Verificar que el backend est√© corriendo
curl http://sat-api-alb-532045601.us-east-1.elb.amazonaws.com/health

# Verificar logs de ECS si est√° en AWS
aws ecs list-tasks --cluster sat-api --service-name sat-api-service
```

#### 4. Sesi√≥n se pierde al recargar p√°gina

**Causa:** Comportamiento normal de Streamlit

**Soluci√≥n:**
- No recargar la p√°gina manualmente (F5)
- Usar botones de navegaci√≥n de la app
- En producci√≥n, implementar JWT para persistencia

#### 5. "Este grupo no tiene miembros" pero s√≠ hay clientes

**Causa:** Cache de sidebar desactualizado

**Soluci√≥n:**
```
1. Click en "Actualizar clientes" en el sidebar
2. O cambiar de grupo y volver
```

#### 6. Error al verificar: "Internal Server Error"

**Causa:** No existen solicitudes para el a√±o seleccionado

**Soluci√≥n:**
- Primero ejecutar "Solicitudes iniciales" para ese a√±o
- Esperar a que se completen las solicitudes
- Luego intentar verificar

## Deployment

### Local (Desarrollo)

```bash
# 1. Clonar repositorio
git clone <repo-url>
cd satisfacture-frontend

# 2. Crear entorno virtual
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# 3. Instalar dependencias
pip install -r requirements.txt

# 4. Configurar variables de entorno
export MONGODB_URI="mongodb+srv://..."
export MONGODB_DB="sat_cfdi"

# 5. Ejecutar
streamlit run app.py
```

### Docker (Producci√≥n)

```dockerfile
# Dockerfile
FROM python:3.12-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app.py .

EXPOSE 8501

CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

```bash
# Build y run
docker build -t satisfacture-frontend .
docker run -p 8501:8501 \
    -e MONGODB_URI="mongodb+srv://..." \
    -e MONGODB_DB="sat_cfdi" \
    satisfacture-frontend
```

### Streamlit Cloud

```toml
# .streamlit/config.toml
[server]
headless = true
port = 8501

[browser]
gatherUsageStats = false
```

```toml
# secrets.toml (no incluir en git)
MONGODB_URI = "mongodb+srv://..."
MONGODB_DB = "sat_cfdi"
```

## Limitaciones Conocidas

### T√©cnicas

1. **Sin persistencia de sesi√≥n:** Al recargar p√°gina se pierde sesi√≥n
2. **Conexi√≥n directa a BD:** No hay capa de abstracci√≥n API
3. **Sin paginaci√≥n:** Todas las consultas traen todos los registros
4. **Sin cach√©:** Cada interacci√≥n consulta BD nuevamente
5. **Timeouts largos:** Solicitudes iniciales pueden tardar 10+ minutos

### Funcionales

1. **Sin edici√≥n de grupos:** No se puede renombrar un grupo
2. **Sin edici√≥n de clientes:** No se puede modificar RFC o raz√≥n social
3. **Sin eliminaci√≥n de clientes:** No hay opci√≥n de borrar clientes
4. **Sin b√∫squeda:** No hay filtros de b√∫squeda en listados
5. **Sin exportaci√≥n:** No se pueden exportar datos a CSV/Excel

### UX

1. **Recarga completa:** Streamlit recarga la p√°gina completa en cada interacci√≥n
2. **Sin confirmaciones:** Operaciones destructivas no piden confirmaci√≥n
3. **Sin feedback visual:** Algunas operaciones no muestran spinner de carga
4. **Sin breadcrumbs:** No hay indicador de ubicaci√≥n en la app
5. **Sin historial:** No se puede volver atr√°s sin perder estado

## Roadmap

### Corto Plazo (1-2 meses)

- [ ] Implementar confirmaciones para operaciones destructivas
- [ ] Agregar b√∫squeda y filtros en listados
- [ ] Mejorar feedback visual con spinners y progress bars
- [ ] Implementar paginaci√≥n para grandes vol√∫menes de datos
- [ ] Agregar exportaci√≥n a CSV/Excel

### Mediano Plazo (3-6 meses)

- [ ] Migrar a React/Next.js para mejor UX
- [ ] Implementar JWT para persistencia de sesi√≥n
- [ ] Agregar edici√≥n de grupos y clientes
- [ ] Sistema de notificaciones en tiempo real
- [ ] Dashboard con m√©tricas y gr√°ficas

### Largo Plazo (6+ meses)

- [ ] Aplicaci√≥n m√≥vil nativa
- [ ] Chat bot integrado
- [ ] IA para insights autom√°ticos
- [ ] Sistema de alertas y notificaciones
- [ ] Multi-idioma (espa√±ol/ingl√©s)

## Contacto y Soporte

### Desarrollador

- **Nombre:** C√©sar
- **Rol:** Data Engineer
- **Email:** apps@basterisreyes.com

### Reportar Problemas

Para reportar bugs o solicitar funcionalidades:

1. Describir el problema o solicitud
2. Incluir pasos para reproducir (si es bug)
3. Adjuntar capturas de pantalla si aplica
4. Especificar navegador y versi√≥n de Python

## Notas Importantes

### Solo para Desarrollo

Esta aplicaci√≥n es una **demo interna** y no est√° dise√±ada para producci√≥n a gran escala. Para uso en producci√≥n, se recomienda:

1. Migrar a framework frontend m√°s robusto (React/Next.js)
2. Implementar autenticaci√≥n con JWT
3. Mover acceso a BD detr√°s de API REST
4. Implementar logging y monitoreo profesional
5. Agregar tests automatizados

### Seguridad

- No usar en producci√≥n sin cambiar credenciales de admin
- No exponer a internet p√∫blico sin autenticaci√≥n adicional
- Considerar implementar rate limiting
- Auditar logs de acceso regularmente

### Performance

- Optimizar consultas a MongoDB con √≠ndices apropiados
- Implementar cach√© para datos que no cambian frecuentemente
- Considerar paginaci√≥n para listados grandes
- Monitorear uso de memoria con m√∫ltiples usuarios concurrentes

---

**SATisFacture Frontend** - Demo interactiva para gesti√≥n fiscal automatizada üá≤üáΩ


*√öltima actualizaci√≥n: Noviembre 2025*
